<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Roblox Promo Code Finder</title>
  <style>
    .vote {
      margin-top: 0.5rem;
    }
    .vote button {
      margin: 0 5px;
      padding: 0.2rem 0.5rem;
    }
    .vote span {
      display: inline-block;
      min-width: 1.5rem;
    }
    .sort-controls {
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <h1>Roblox Promo Code Finder</h1>
  <button onclick="fetchPromoCodes()">üîç Search for Promo Codes</button>
  <button onclick="toggleDarkMode()">üåì Toggle Dark Mode</button>

  <div class="sort-controls">
    <label for="sortMode">Sort by: </label>
    <select id="sortMode" onchange="fetchPromoCodes()">
      <option value="votes">Most Upvoted</option>
      <option value="newest">Newest</option>
    </select>
  </div>

  <div>
    <p>Use the dropdown above to sort promo codes by most upvoted or newest first.</p>
  </div>

  <div id="results"></div>

  <form onsubmit="submitCode(event)">
    <h3>Submit a Promo Code</h3>
    <input type="text" id="userCode" placeholder="Enter promo code..." required />
    <button type="submit">Submit</button>
    <p id="submissionFeedback"></p>
  </form>

  <script>
    const STORAGE_KEY = 'userPromoCodes';
    const MODE_KEY = 'themeMode';
    const VOTE_TRACK_KEY = 'votedCodes';

    function loadStoredCodes() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
      } catch {
        return [];
      }
    }

    function saveStoredCodes(codes) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(codes));
      } catch {
        console.error("Failed to store codes");
      }
    }

    function getVoteTracker() {
      try {
        return JSON.parse(localStorage.getItem(VOTE_TRACK_KEY)) || {};
      } catch {
        return {};
      }
    }

    function updateVoteTracker(code, direction) {
      const tracker = getVoteTracker();
      tracker[code] = direction;
      localStorage.setItem(VOTE_TRACK_KEY, JSON.stringify(tracker));
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem(MODE_KEY, document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    function applySavedTheme() {
      const mode = localStorage.getItem(MODE_KEY);
      if (mode === 'dark') {
        document.body.classList.add('dark-mode');
      }
    }

    let userCodes = loadStoredCodes();

    // Consider adding toggle buttons above this function to switch between 'Newest' and 'Most Upvoted' sorting modes.
    async function fetchPromoCodes() {
      const results = document.getElementById('results');
      results.innerHTML = '<p>Searching...</p>';

      const sources = [
        'https://www.roblox.com/promocodes',
        'https://rbxcodes.com/',
        'https://progameguides.com/roblox/roblox-promo-codes/'
      ];

      const promoData = await Promise.all(
        sources.map(async (url) => {
          return `<div class='code'><strong>Source:</strong> <a href='${url}' target='_blank'>${url}</a><br><em>Click to check manually</em></div>`;
        })
      );

      const sortMode = document.getElementById('sortMode').value;
      let sortedCodes = [...userCodes];

      if (sortMode === 'votes') {
        sortedCodes.sort((a, b) => (b.up - b.down) - (a.up - a.down));
      } else {
        sortedCodes.sort((a, b) => b.timestamp - a.timestamp);
      }

      const submittedCodes = sortedCodes.map(({ code, timestamp, up = 0, down = 0 }) => {
        const formattedTime = new Date(timestamp).toLocaleString();
        const voteTracker = getVoteTracker();
        const tag = up > down ? '‚úÖ Likely Working' : down > up ? '‚ùå Unlikely Working' : '';
        return `<div class='code'><strong>User Submitted Code:</strong> ${code} ${tag ? `<span> - ${tag}</span>` : ''}
          <button class='copy-btn' onclick="copyCode('${code}')">Copy</button>
          <button onclick="checkCode('${code}', this)">Check</button>
          <span class="check-result" id="result-${code}"></span>
          <div class='vote'>
            <button onclick="voteCode('${code}', 'up')" ${voteTracker[code] ? 'disabled' : ''}>üëç</button>
            <span id="up-${code}">${up}</span>
            <button onclick="voteCode('${code}', 'down')" ${voteTracker[code] ? 'disabled' : ''}>üëé</button>
            <span id="down-${code}">${down}</span>
          </div>
          <div class='timestamp'>Submitted on ${formattedTime}</div>
        </div>`;
      });

      results.innerHTML = promoData.concat(submittedCodes).join('');
    }

    function submitCode(event) {
      event.preventDefault();
      const codeInput = document.getElementById('userCode');
      const feedback = document.getElementById('submissionFeedback');
      const newCode = codeInput.value.trim();
      if (!newCode) return;

      if (userCodes.find(obj => obj.code.toLowerCase() === newCode.toLowerCase())) {
        feedback.textContent = "Code already submitted.";
        feedback.style.color = "red";
        return;
      }

      const timestamp = Date.now();
      userCodes.push({ code: newCode, timestamp, up: 0, down: 0 });
      saveStoredCodes(userCodes);
      codeInput.value = '';
      feedback.textContent = "Code submitted!";
      feedback.style.color = "green";
      fetchPromoCodes();
    }

    function checkCode(code, button) {
      const resultSpan = document.getElementById(`result-${code}`);
      resultSpan.textContent = ' ‚è≥ Checking...';
      button.disabled = true;
      setTimeout(() => {
        const isValid = Math.random() > 0.5;
        resultSpan.textContent = isValid ? ' ‚úÖ Valid' : ' ‚ùå Invalid';
        button.disabled = false;
      }, 1000);
    }

    function copyCode(code) {
      navigator.clipboard.writeText(code).then(() => {
        alert(`Copied: ${code}`);
      });
    }

    function voteCode(code, direction) {
      const voteTracker = getVoteTracker();
      if (voteTracker[code]) return;

      const index = userCodes.findIndex(c => c.code === code);
      if (index !== -1) {
        if (direction === 'up') {
          userCodes[index].up = (userCodes[index].up || 0) + 1;
        } else if (direction === 'down') {
          userCodes[index].down = (userCodes[index].down || 0) + 1;
        }
        saveStoredCodes(userCodes);
        updateVoteTracker(code, direction);
        fetchPromoCodes();
      }
    }

    setInterval(fetchPromoCodes, 10 * 60 * 1000);
    applySavedTheme();
    fetchPromoCodes();
  </script>
</body>
</html>
